<!DOCTYPE html>
<html>
<head>
    <title>Conflict Resolution Test</title>
    <style>
        body { font-family: system-ui; padding: 20px; }
        .client { border: 1px solid #ddd; margin: 10px; padding: 15px; }
        .status { font-weight: bold; margin-bottom: 10px; }
        textarea { width: 100%; height: 150px; margin: 10px 0; }
        .info { font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <h1>Multi-Client Conflict Resolution Test</h1>
    <p>Open multiple browser windows/tabs to test real-time collaboration</p>
    
    <div class="client">
        <div class="status" id="status1">Client 1: Disconnected</div>
        <textarea id="editor1" placeholder="Type here as Client 1..."></textarea>
        <div class="info">Server Version: <span id="version1">0</span> | Pending Ops: <span id="pending1">0</span></div>
    </div>

    <div class="client">
        <div class="status" id="status2">Client 2: Disconnected</div>
        <textarea id="editor2" placeholder="Type here as Client 2..."></textarea>
        <div class="info">Server Version: <span id="version2">0</span> | Pending Ops: <span id="pending2">0</span></div>
    </div>

    <script>
        // Test with two simulated clients
        const docId = 'conflict-test';
        
        function createClient(clientNum) {
            const editor = document.getElementById(`editor${clientNum}`);
            const status = document.getElementById(`status${clientNum}`);
            const versionSpan = document.getElementById(`version${clientNum}`);
            const pendingSpan = document.getElementById(`pending${clientNum}`);
            
            let ws = null;
            let serverVersion = 0;
            let pendingOps = [];
            let sequenceNumber = 0;
            let debounceTimer = null;
            let applyingRemote = false;
            
            function connect() {
                const wsUrl = `ws://localhost:80/ws?docId=${encodeURIComponent(docId)}`;
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    status.textContent = `Client ${clientNum}: Connected`;
                    status.style.color = 'green';
                    
                    // Request snapshot
                    ws.send(JSON.stringify({ type: "snapshot_request", docId }));
                    
                    // Send pending operations
                    pendingOps.forEach(op => {
                        ws.send(JSON.stringify(op));
                    });
                };
                
                ws.onmessage = (evt) => {
                    try {
                        const msg = JSON.parse(evt.data);
                        
                        if (msg.type === "snapshot") {
                            applyingRemote = true;
                            editor.value = msg.text || "";
                            serverVersion = msg.version || 0;
                            versionSpan.textContent = serverVersion;
                            applyingRemote = false;
                            return;
                        }
                        
                        // Handle edit messages
                        if (msg.opId) {
                            // Remove confirmed operations from pending
                            pendingOps = pendingOps.filter(op => op.opId !== msg.opId);
                            pendingSpan.textContent = pendingOps.length;
                            
                            const incomingVersion = msg.version || msg.serverVersion || 0;
                            if (incomingVersion > serverVersion) {
                                applyingRemote = true;
                                editor.value = msg.text || "";
                                serverVersion = incomingVersion;
                                versionSpan.textContent = serverVersion;
                                applyingRemote = false;
                            }
                        }
                    } catch (err) {
                        console.error(`Client ${clientNum} parse error:`, err);
                    }
                };
                
                ws.onclose = () => {
                    status.textContent = `Client ${clientNum}: Disconnected`;
                    status.style.color = 'red';
                    
                    // Reconnect after delay
                    setTimeout(connect, 2000);
                };
                
                ws.onerror = (e) => {
                    console.error(`Client ${clientNum} WebSocket error:`, e);
                };
            }
            
            function sendOperation(text) {
                sequenceNumber++;
                const op = {
                    type: "edit",
                    opId: `client${clientNum}-${Date.now()}-${Math.random()}`,
                    sequence: sequenceNumber,
                    origin: `client${clientNum}`,
                    docId: docId,
                    text: text,
                    version: serverVersion + 1,
                    timestamp: Date.now()
                };
                
                pendingOps.push(op);
                pendingSpan.textContent = pendingOps.length;
                
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(op));
                }
            }
            
            editor.addEventListener('input', (e) => {
                if (applyingRemote) return;
                
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    sendOperation(e.target.value);
                }, 300);
            });
            
            connect();
        }
        
        // Create both clients
        createClient(1);
        createClient(2);
    </script>
</body>
</html>